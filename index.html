<script>
    const animationDuration = 800; // Animation duration in ms
    const attackLock = {}; // Prevent multiple attacks during animation

    function replaceSprite(player, action, callback) {
        if (!player || !player.img) return; // Ensure player and image are initialized

        const originalSrc = player.img.src;
        const actionSrc = originalSrc.replace(/(\w+)\.png$/, `${action}$1.png`); // Generate attack sprite URL

        player.img.src = actionSrc; // Set attack sprite

        setTimeout(() => {
            player.img.src = originalSrc; // Revert to original sprite
            if (callback) callback();
        }, animationDuration);
    }

    window.addEventListener('keydown', e => {
        const key = e.key.toLowerCase();

        // Player 1 attacks
        if (key === 'q' && player1 && !attackLock['q']) {
            attackLock['q'] = true;
            replaceSprite(player1, 'punch', () => {
                applyKnockback(player2, punchDamage, player2.damage);
                attackLock['q'] = false;
            });
        } else if (key === 'e' && player1 && !attackLock['e']) {
            attackLock['e'] = true;
            replaceSprite(player1, 'kick', () => {
                applyKnockback(player2, kickDamage, player2.damage);
                attackLock['e'] = false;
            });
        }

        // Player 2 attacks
        if (key === 'm' && player2 && !attackLock['m']) {
            attackLock['m'] = true;
            replaceSprite(player2, 'punch', () => {
                applyKnockback(player1, punchDamage, player1.damage);
                attackLock['m'] = false;
            });
        } else if (key === 'n' && player2 && !attackLock['n']) {
            attackLock['n'] = true;
            replaceSprite(player2, 'kick', () => {
                applyKnockback(player1, kickDamage, player1.damage);
                attackLock['n'] = false;
            });
        }
    });

    function drawPlayer(player) {
        if (player && player.img.complete) {
            ctx.drawImage(player.img, player.x, player.y, player.width, player.height);
        }
    }
</script>
